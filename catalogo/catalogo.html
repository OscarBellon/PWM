<!DOCTYPE html>
<html>
    <head>
        <script src="https://www.w3schools.com/lib/w3.js"></script>
        <link rel="stylesheet" type="text/css" href="catalogo.css">
    </head>
    <body>
        <header id="header"></header>
        <main>
            <nav>
                <div id="menuToggle">
                    <input type="checkbox" />
                    <span></span>
                    <span></span>
                    <span></span>
                    <ul id="menu">
                        <li id="adaptadores">Adaptadores</li>
                        <li id="cableado"><a href="#">Cableado</a></li>
                        <li id="detectores"><a href="#">Detectores</a></li>
                        <li id="electronica"><a href="#">Electrónica</a></li>
                        <li id="iluminacion"><a href="#">Iluminación</a></li>
                    </ul>
                </div>
            </nav>

            <section id="contenedorDeProductos">
                <template id="producto">
                    <article></article>
                </template>
            </section>
            
        </main>
        <footer id="footer"></footer>
    </body>
    <script src="/Componentes/carrusel/js/swiper-bundle.min.js"></script>

    <!-- JavaScript -->
    <script src="/Componentes/carrusel/js/script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', init);

        document.getElementById("adaptadores").addEventListener("click",function () {
            removeProducts();
            addProducts("adaptadores");
        })
        document.getElementById("cableado").addEventListener("click",function () {
            removeProducts();
            addProducts("cableado");
        })
        document.getElementById("detectores").addEventListener("click",function () {
            removeProducts();
            addProducts("sensores");
        })
        document.getElementById("electronica").addEventListener("click",function () {
            removeProducts();
            addProducts("electronica");
        })
        document.getElementById("iluminacion").addEventListener("click",function () {
            removeProducts();
            addProducts("iluminacion");
        })

        function removeProducts() {
            document.querySelectorAll("article").forEach(element => {
                element.remove();
            });
        }
        

        const supportsTemplate = function () {
            //create a template element and make sure it has a 'content' property
            return 'content' in document.createElement('template');
        }

        function loadTemplate(fileName, id, callback) {

            fetch(fileName).then((res) => {
                return res.text();
            }).then((text) => {
                document.getElementById(id).innerHTML = text;
                //console.log(text)

                if(callback){
                    callback();
                }
            })
        }
        
        function init() {
            loadTemplate("/Componentes/Header/header.html","header");
            loadTemplate("/Componentes/footer/footer.html","footer");
            addProducts();

        }

        function addProducts(filtro){
            fetch("/resources/productos.json")
            .then((response) => {
                return response.json();
            })
            .then((products) =>{
                if ('content' in document.createElement('template')) {
                    const container = document.getElementById('contenedorDeProductos');
                    
                    if (filtro!=null) {
                        products=products.filter(producto => producto.seccion== filtro);
                    }
                    
                    products.forEach((product) => {

                        const tmpl = document
                            .getElementById('producto')
                            .content.cloneNode(true);
                        
                        var htmldir = "";

                        fetch("/catalogo/productoComponente.html")
                        .then((res)=>{
                            return res.text();
                        }).then((text)=>{
                            //console.log(text);
                            const tmpl = document
                                .getElementById('producto')
                                .content.cloneNode(true);
                            

                            tmpl.querySelector('article').innerHTML= text;
                            tmpl.querySelector(".nombreProducto").innerText=product.nombre;
                            tmpl.querySelector(".precio").innerText=product.precio;
                            if (product.disponibilidad) {
                                console.log("cambio de color")
                                tmpl.querySelector(".circulo").style.background="#03738c";
                            } else {
                                tmpl.querySelector(".circulo").style.background="lightcoral";
                            }

                            tmpl.querySelector("article").addEventListener("click",
                            function () {
                                fetch("/catalogo/producto.html")
                                .then((res)=>{
                                    return res.text();
                                })
                                .then((productoHtml)=>{
                                    var parser = new DOMParser();
                                    var doc = parser.parseFromString(productoHtml, "text/html");
                                    doc.querySelector(".precio").innerText=product.precio+" €";
                                    doc.querySelector(".nombreProducto").innerText=product.nombre;

                                    if (product.disponibilidad) {
                                        doc.querySelector(".circulo").style.background="#03738c"
                                    } else{
                                        doc.querySelector(".circulo").style.background="lightcoral"
                                    }

                                    
                                    document.querySelector("html").innerHTML=doc.querySelector("html").innerHTML;
                                    loadTemplate("/Componentes/carrusel/carrusel.html","carrusel",function () {
                                        console.log(document.querySelectorAll(".card"));
                                        document.querySelectorAll(".card").forEach(element => {
                                        console.log("hey");
                                        loadTemplateToElement("/catalogo/productoComponente.html",element);
                                        let script1 =document.createElement("script")
                                        script1.setAttribute("src","/catalogo/js/script.js")
                                        document.body.appendChild(script1)
                                        let script2 =document.createElement("script")
                                        script2.setAttribute("src","/catalogo/js/swiper-bundle.min.js")
                                        document.body.appendChild(script2)
                                    });
                                    });
                                    
                                    
                                    
                                    init();
                                })
                            })
                            container.appendChild(tmpl);
                        })
                        

                        
                        
                    });
                } else {
                    console.error('Your browser does not support templates');
                }
            })
        }
        function loadTemplateToElement(fileName, obj, callback) {

            fetch(fileName).then((res) => {
                return res.text();
            }).then((text) => {
                obj.innerHTML = text;
                console.log(text)

                if(callback){
                    callback();
                }
            })
        }

        function myCallback(){
            document.querySelectorAll(".card").forEach(element => {
                loadTemplateToElement("/catalogo/productoComponente.html",element);
            });
        }
    </script>

</html>